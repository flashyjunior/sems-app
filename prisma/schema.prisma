// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Roles - for role-based access control
model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  permissions Permission[]
  users       User[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([name])
}

// Permissions - fine-grained access control
model Permission {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  roles       Role[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
}

// Pharmacy - Multi-pharmacy support
model Pharmacy {
  id              String         @id @default(cuid())
  name            String         @unique
  location        String?
  address         String?
  phone           String?
  email           String?
  licenseNumber   String?        @unique
  manager         String?
  isActive        Boolean        @default(true)
  config          String?        // JSON config for pharmacy-specific settings
  
  // Relations
  users           User[]
  dispenseRecords DispenseRecord[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([name])
  @@index([isActive])
}

// Users
model User {
  id                Int          @id @default(autoincrement())
  email             String       @unique
  fullName          String
  phone             String?
  password          String       // bcrypt hashed
  licenseNumber     String       @unique
  specialization    String?
  theme             String       @default("auto")
  language          String       @default("en")
  defaultDoseUnit   String       @default("mg")
  autoLock          Boolean      @default(false)
  autoLockMinutes   Int          @default(15)
  isActive          Boolean      @default(true)
  lastLogin         DateTime?
  roleId            Int
  pharmacyId        String?      // Primary pharmacy for this user
  role              Role         @relation(fields: [roleId], references: [id], onDelete: Cascade)
  pharmacy          Pharmacy?    @relation(fields: [pharmacyId], references: [id], onDelete: SetNull)
  activityLogs      ActivityLog[]
  dispenseRecords   DispenseRecord[]
  apiKeys           ApiKey[]
  tickets           Ticket[]
  savedPresets      SavedPreset[]
  exportJobs        ExportJob[]
  alertTickets      AlertTicket[]
  ticketNotes       TicketNote[]
  ticketNotifications TicketNotification[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([email])
  @@index([licenseNumber])
  @@index([roleId])
}

// Printers
model Printer {
  id            Int               @id @default(autoincrement())
  name          String
  location      String?
  ipAddress     String?
  modelNumber   String?
  serialNumber  String?
  isDefault     Boolean           @default(false)
  isActive      Boolean           @default(true)
  lastSync      DateTime?
  settings      PrinterSettings?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([name])
  @@index([ipAddress])
  @@index([isDefault])
}

// Printer Settings
model PrinterSettings {
  id           Int      @id @default(autoincrement())
  printerId    Int      @unique
  printer      Printer  @relation(fields: [printerId], references: [id], onDelete: Cascade)
  paperSize    String   @default("A4")
  orientation  String   @default("portrait")
  colorMode    String   @default("bw")
  quality      String   @default("normal")
  copies       Int      @default(1)
  autoSync     Boolean  @default(true)
  syncInterval Int      @default(300)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([printerId])
}

// System Settings
model SystemSettings {
  id                 Int      @id @default(autoincrement())
  facilityName       String
  facilityLogo       String?
  address            String?
  phoneNumber        String?
  email              String?
  pharmacyId         String?  // Unique identifier for this pharmacy outlet
  autoSyncEnabled    Boolean  @default(true)
  syncInterval       Int      @default(300)
  dataRetention      Int      @default(365)
  dataRetentionUnit  String   @default("days")
  auditLogging       Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([facilityName])
  @@index([pharmacyId])
}

// Activity Log - Audit Trail
model ActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String
  resource  String
  resourceId String?
  changes   String?  // JSON stringified changes
  ipAddress String?
  userAgent String?
  status    String   @default("success")
  errorMsg  String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([resource])
}

// Dispense Records - Medication dispensing audit trail
model DispenseRecord {
  id              Int       @id @default(autoincrement())
  externalId      String    @unique
  userId          Int
  pharmacyId      String?   // Which pharmacy this dispense was made at
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  pharmacy        Pharmacy? @relation(fields: [pharmacyId], references: [id], onDelete: SetNull)
  patientName     String?
  patientPhoneNumber String?
  patientAge      Int?
  patientWeight   Float?
  drugId          String
  drugName        String
  dose            String    // JSON stringified DoseCalculation
  safetyAcks      String    // JSON stringified array
  printedAt       DateTime?
  deviceId        String
  auditLog        String?   // JSON stringified array
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([pharmacyId])
  @@index([drugId])
  @@index([createdAt])
  @@index([externalId])
}

// API Keys for external integrations
model ApiKey {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  key       String    @unique
  name      String
  isActive  Boolean   @default(true)
  lastUsed  DateTime?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([key])
}
// Drugs - Master reference data
model Drug {
  id                  String   @id @default(cuid())
  genericName         String
  tradeName           String[] // JSON array of trade names
  strength            String
  route               String   @default("oral")
  category            String
  stgReference        String?
  contraindications   String[] // JSON array
  pregnancyCategory   String?  // A, B, C, D, X
  warnings            String[] // JSON array
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([genericName])
  @@index([category])
}

// Dose Regimens - Master reference data
model DoseRegimen {
  id              String  @id @default(cuid())
  drugId          String
  ageMin          Int?
  ageMax          Int?
  weightMin       Float?
  weightMax       Float?
  ageGroup        String  @default("adult") // adult, pediatric, neonatal
  doseMg          String
  frequency       String
  duration        String
  maxDoseMgDay    String?
  route           String  @default("oral")
  instructions    String?
  isActive        Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([drugId])
  @@index([ageGroup])
}

// Print Templates - Master reference data
model PrintTemplate {
  id              String   @id @default(cuid())
  name            String
  description     String?
  htmlTemplate    String   @db.Text // HTML template for browser printing
  escposTemplate  String?  @db.Text // ESC/POS format for thermal printers
  isDefault       Boolean  @default(false)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([name])
  @@index([isDefault])
}

// Support Tickets
model Ticket {
  id              String   @id @default(cuid())
  ticketNumber    String   @unique
  userId          Int
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title           String
  description     String   @db.Text
  category        String   @default("general") // technical, feature-request, bug-report, general, urgent
  priority        String   @default("medium") // low, medium, high, critical
  status          String   @default("open") // open, in-progress, resolved, closed, on-hold
  attachments     String? // JSON array of attachment URLs
  notes           TicketNote[]
  notifications   TicketNotification[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  resolvedAt      DateTime?
  closedAt        DateTime?

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([ticketNumber])
}

// Ticket Notes/Comments
model TicketNote {
  id              String   @id @default(cuid())
  ticketId        String
  ticket          Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId          Int
  user            User     @relation(fields: [userId], references: [id], onDelete: SetNull)
  content         String   @db.Text
  isAdminNote     Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([ticketId])
  @@index([userId])
}

// Ticket Notifications
model TicketNotification {
  id              String   @id @default(cuid())
  ticketId        String
  ticket          Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId          Int
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            String   @default("ticket-updated") // ticket-created, ticket-updated, ticket-resolved, ticket-closed, admin-response
  message         String   @db.Text
  read            Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([ticketId])
  @@index([read])
}

// SMTP Settings
model SMTPSettings {
  id              String   @id @default(cuid())
  host            String
  port            Int
  secure          Boolean  @default(true)
  username        String
  password        String   // Should be encrypted in production
  fromEmail       String
  fromName        String
  adminEmail      String
  replyToEmail    String?
  enabled         Boolean  @default(false)
  testStatus      String? // pending, success, failed
  lastTestedAt    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Temporary Drugs - Pending admin approval
model TempDrug {
  id                  String   @id @default(cuid())
  genericName         String
  tradeName           String[] // JSON array of trade names
  strength            String
  route               String   @default("oral")
  category            String
  stgReference        String?
  contraindications   String[] // JSON array
  pregnancyCategory   String?  // A, B, C, D, X
  warnings            String[] // JSON array
  createdByPharmacistId String?
  status              String   @default("pending") // pending, approved, rejected
  approvedByAdminId   String?
  approvedAt          DateTime?
  rejectionReason     String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([genericName])
  @@index([status])
  @@index([createdAt])
}

// Temporary Dose Regimens - Pending admin approval
model TempDoseRegimen {
  id              String  @id @default(cuid())
  tempDrugId      String
  drugId          String? // Reference to original drug if editing existing
  ageMin          Int?
  ageMax          Int?
  weightMin       Float?
  weightMax       Float?
  ageGroup        String  @default("adult") // adult, pediatric, neonatal
  doseMg          String
  frequency       String
  duration        String
  maxDoseMgDay    String?
  route           String  @default("oral")
  instructions    String?
  createdByPharmacistId String?
  status          String  @default("pending") // pending, approved, rejected
  approvedByAdminId   String?
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tempDrugId])
  @@index([status])
  @@index([createdAt])
}

// DPAP Analytics - Dispensing Events (Event Source of Truth)
model DispensingEvent {
  id                    String    @id @default(cuid())
  dispenseRecordId      String    @unique
  timestamp             DateTime
  pharmacyId            String
  userId                Int
  drugId                String
  drugName              String
  genericName           String?
  patientAgeGroup       String    // 'paediatric' | 'adult' | 'geriatric'
  isPrescription        Boolean   @default(true)
  isControlledDrug      Boolean   @default(false)
  isAntibiotic          Boolean   @default(false)
  stgCompliant          Boolean   @default(true)
  overrideFlag          Boolean   @default(false)
  patientIsPregnant     Boolean   @default(false)
  
  // Risk scoring results
  riskScore             Int       @default(0)
  riskCategory          String    @default("none") // 'none' | 'low' | 'medium' | 'high' | 'critical'
  riskFlags             String    // JSON array of risk flags
  highRiskFlag          Boolean   @default(false)
  
  // Relations
  alerts                HighRiskAlert[]
  
  // Audit trail
  createdAt             DateTime  @default(now())
  syncedAt              DateTime?
  
  @@index([pharmacyId, timestamp])
  @@index([timestamp])
  @@index([riskCategory])
  @@index([highRiskFlag])
  @@index([userId])
  @@index([drugId])
}

// DPAP Analytics - Daily Summary Cache (For Dashboard)
model DailySummaryCache {
  id                    String    @id @default(cuid())
  date                  DateTime
  pharmacyId            String
  
  // KPIs
  totalPrescriptions    Int       @default(0)
  totalOTC              Int       @default(0)
  avgDispensingTime     Float     @default(0)
  prescriptionRatio     Float     @default(0)
  highRiskEvents        Int       @default(0)
  stgComplianceRate     Float     @default(100)
  
  // Risk distribution
  noneRiskCount         Int       @default(0)
  lowRiskCount          Int       @default(0)
  mediumRiskCount       Int       @default(0)
  highRiskCount         Int       @default(0)
  criticalRiskCount     Int       @default(0)
  
  // Top medicines (JSON)
  topMedicines          String    // JSON array of {drugId, count, riskLevel}
  
  // Hourly distribution (JSON)
  hourlyDistribution    String    // JSON array of {hour, count, prescriptions}
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@unique([date, pharmacyId])
  @@index([date])
  @@index([pharmacyId])
}

// DPAP Analytics - High Risk Alerts (For Operations)
model HighRiskAlert {
  id                    String    @id @default(cuid())
  dispensingEventId     String
  dispensingEvent       DispensingEvent @relation(fields: [dispensingEventId], references: [id], onDelete: Cascade)
  pharmacyId            String
  timestamp             DateTime
  
  drugName              String
  patientAgeGroup       String
  riskScore             Int
  riskCategory          String
  flags                 String    // JSON array of flags
  
  // Review status
  reviewedBy            Int?
  reviewedAt            DateTime?
  reviewNotes           String?
  alertTickets          AlertTicket[]
  
  createdAt             DateTime  @default(now())
  
  @@index([pharmacyId, timestamp])
  @@index([reviewedBy])
  @@index([createdAt])
  @@index([dispensingEventId])
}


// User-saved analytics presets
model SavedPreset {
  id        String   @id @default(cuid())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  name      String
  startDate DateTime
  endDate   DateTime
  pharmacyId String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([name])
}

// Webhook endpoints for alerts
model WebhookEndpoint {
  id        String   @id @default(cuid())
  name      String
  url       String
  secret    String?
  isActive  Boolean  @default(true)
  createdBy Int?
  createdAt DateTime @default(now())

  @@index([isActive])
}

// Async export jobs
model ExportJob {
  id         String   @id @default(cuid())
  userId     Int?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  type       String
  payload    String   // JSON payload
  status     String   @default("queued")
  resultUrl  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([status])
  @@index([userId])
}

// Alert triage tickets linked to high risk alerts
model AlertTicket {
  id             String   @id @default(cuid())
  alertId        String
  alert          HighRiskAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)
  createdBy      Int?
  createdByUser  User?    @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  createdAt      DateTime @default(now())
  note           String?
  externalTicketId String?

  @@index([alertId])
  @@index([createdBy])
}